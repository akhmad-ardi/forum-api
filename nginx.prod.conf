##
# ============================================================
# NGINX CONFIGURATION — PRODUCTION (HTTPS + RATE LIMITING)
# Environment : Production (UpCloud VM)
# OS          : Ubuntu 22
# Project     : Forum API (reverse proxy → localhost:5000)
# Domain      : easy-lemons-wave-brightly.st.a.dcdg.xyz
# ============================================================
##

user www-data;
worker_processes auto;
pid /run/nginx.pid;

include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    sendfile on;
    keepalive_timeout 65;

    # --------------------------------------------------------
    # RATE LIMITING (90 request/menit per IP)
    # --------------------------------------------------------
    limit_req_zone $binary_remote_addr zone=one:10m rate=90r/m;

    # --------------------------------------------------------
    # HTTPS SERVER
    # --------------------------------------------------------
    server {
        listen 443 ssl;
        listen [::]:443 ssl ipv6only=on;

        server_name easy-lemons-wave-brightly.st.a.dcdg.xyz www.easy-lemons-wave-brightly.st.a.dcdg.xyz;

        # Sertifikat SSL dari Certbot
        ssl_certificate     /etc/letsencrypt/live/easy-lemons-wave-brightly.st.a.dcdg.xyz/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/easy-lemons-wave-brightly.st.a.dcdg.xyz/privkey.pem;
        include /etc/letsencrypt/options-ssl-nginx.conf;
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

        root /var/www/html;
        index index.html index.htm index.nginx-debian.html;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        # Endpoint /threads (rate limited)
        location /threads {
            proxy_pass http://localhost:5000/threads;
            limit_req zone=one burst=20 nodelay;
        }

        # Root endpoint
        location / {
            proxy_pass http://localhost:5000;
        }

        error_page 503 @limit;
        location @limit {
            default_type text/plain;
            return 503 "Too many requests. Please try again later.\n";
        }
    }

    # --------------------------------------------------------
    # HTTP SERVER → redirect ke HTTPS
    # --------------------------------------------------------
    server {
        listen 80 default_server;
        listen [::]:80 default_server;

        server_name easy-lemons-wave-brightly.st.a.dcdg.xyz www.easy-lemons-wave-brightly.st.a.dcdg.xyz;

        if ($host = www.easy-lemons-wave-brightly.st.a.dcdg.xyz) {
            return 301 https://$host$request_uri;
        }

        if ($host = easy-lemons-wave-brightly.st.a.dcdg.xyz) {
            return 301 https://$host$request_uri;
        }

        return 404;
    }
}
