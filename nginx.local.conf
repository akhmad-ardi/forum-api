##
# ============================================================
# NGINX CONFIGURATION — LOCAL ENVIRONMENT (HTTP ONLY)
# Environment : Local / Development
# OS          : Ubuntu 22 (local)
# Project     : Forum API (reverse proxy → localhost:5000)
# ============================================================
##

user www-data;
worker_processes auto;
pid /run/nginx.pid;

include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    sendfile on;
    keepalive_timeout 65;

    # --------------------------------------------------------
    # RATE LIMITING (90 request/menit per IP)
    # --------------------------------------------------------
    limit_req_zone $binary_remote_addr zone=one:10m rate=90r/m;

    # --------------------------------------------------------
    # LOCAL SERVER (HTTP ONLY)
    # --------------------------------------------------------
    server {
        listen 80;
        listen [::]:80;
        server_name localhost;

        root /var/www/html;
        index index.html index.htm index.nginx-debian.html;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        # Endpoint /threads (rate limited)
        location /threads {
            proxy_pass http://127.0.0.1:5000/threads;
            limit_req zone=one burst=20 nodelay;
        }

        # Root endpoint
        location / {
            proxy_pass http://127.0.0.1:5000;
        }

        # Error page jika rate limit tercapai
        error_page 503 @limit;
        location @limit {
            default_type text/plain;
            return 503 "Too many requests. Please try again later.\n";
        }
    }
}
