name: Deploy via Ngrok SSH

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: SSH and deploy app
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            export PATH=$PATH:/home/ardi/.nvm/versions/node/v22.15.0/bin:/usr/local/bin:/usr/bin:/bin
            
            PROJECT_DIR=~/forum-api

            echo "Starting deployment on $(hostname)..."

            if [ ! -d "$PROJECT_DIR/.git" ]; then
              echo "Project not found, cloning for the first time..."
              git clone https://github.com/akhmad-ardi/forum-api.git $PROJECT_DIR
              cd $PROJECT_DIR
            else
              echo "Project exists, pulling latest changes..."
              cd $PROJECT_DIR
              git fetch origin main
              git reset --hard origin/main
            fi

            echo "Installing dependencies..."
            npm ci --production

            echo "Running migrations..."
            npm run migrate up || echo "No migration step found"

            echo "Restarting PM2 process..."
            pm2 restart forum-api || pm2 start src/app.js --name forum-api

            # reload nginx jika konfigurasi berubah
            echo "Reloading nginx..."
            sudo nginx -t && sudo systemctl reload nginx

            echo "Deployment complete!"
